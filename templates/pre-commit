#!/bin/sh
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(php|inc|module|install|theme)$')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

echo "ğŸ” Running PHP CodeSniffer on staged files:"
echo "$STAGED_FILES"

# Autofix Section
echo "ğŸ¨ Attempting auto-fixes..."
vendor/bin/phpcbf --standard=phpcs.xml.dist $STAGED_FILES
git add $STAGED_FILES

# â¬‡ï¸â¬‡ï¸â¬‡ï¸ HERE WE ADD A MESSAGE â¬‡ï¸â¬‡ï¸â¬‡ï¸
echo "ğŸ’¡ Auto-fixes applied. Check 'git diff --staged' for changes."
# â¬†ï¸â¬†ï¸â¬†ï¸ END OF ADDING MESSAGE â¬†ï¸â¬†ï¸â¬†ï¸

echo "ğŸš¦ Checking code quality..."
vendor/bin/phpcs --standard=phpcs.xml.dist -d memory_limit=1024M --runtime-set timeout 300 $STAGED_FILES

PHPCS_EXIT_CODE=$?
if [ $PHPCS_EXIT_CODE -ne 0 ]; then
  echo "âŒ PHP CodeSniffer found issues! Commit blocked."
  echo "â„¹ï¸ To attempt auto-fixes, run: composer run lint-fix"
  exit 1
fi

exit 0